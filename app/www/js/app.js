// Generated by CoffeeScript 1.4.0

/*
Resets, fixes 'n' shit
*/


(function() {
  var $alarmTime, $cancelButton, $submitButton, alarmComplete, alarmIsSet, cancelDeepSleepCountdown, checkAlarmAgainstTime, countdownToDeepSleep, duration, injectThoughts, interruptDeepSleepCountdown, startMonitoringMovement, stopMonitoringMovement, toggleAlarm;

  window.addEventListener("load", function() {
    return new FastClick(document.body);
  }, false);

  $("input").blur(function() {
    return window.scrollTo(0, 0);
  });

  /*
  UI Elements
  */


  alarmIsSet = false;

  $alarmTime = $("#alarm-time");

  $submitButton = $("#alarm-submit");

  $cancelButton = $("#alarm-cancel");

  duration = 10000;

  /*
  Bind events
  */


  $submitButton.bind("click", function() {
    toggleAlarm();
    countdownToDeepSleep();
    return startMonitoringMovement();
  });

  $cancelButton.bind("click", function() {
    toggleAlarm();
    return stopMonitoringMovement(window.accelerometerMonitor);
  });

  /*
  Alarm Clock logic
  */


  toggleAlarm = function() {
    var alarmTime, hour, mins, splitAlarmTime;
    alarmTime = $alarmTime.val();
    splitAlarmTime = alarmTime.split(":");
    hour = parseInt(splitAlarmTime[0]);
    mins = parseInt(splitAlarmTime[1]);
    if (!alarmIsSet) {
      alarmIsSet = true;
      $(".main").fadeOut(1000, function() {
        return $(".night-mode").fadeIn(1000);
      });
      window.ticker = setInterval(function() {
        return checkAlarmAgainstTime(hour, mins);
      }, 1000);
      return console.log("Alarm is set for " + hour + ":" + mins);
    } else {
      alarmIsSet = false;
      $(".night-mode").fadeOut(1000, function() {
        return $(".main").fadeIn(1000);
      });
      clearInterval(window.ticker);
      cancelDeepSleepCountdown();
      return console.log("Alarm cancelled");
    }
  };

  checkAlarmAgainstTime = function(hour, minutes) {
    var currentHour, currentMins, date;
    date = new Date;
    currentHour = date.getHours();
    currentMins = date.getMinutes();
    if (hour === currentHour && minutes === currentMins) {
      return alarmComplete();
    } else {
      return console.log("tick");
    }
  };

  alarmComplete = function() {
    navigator.notification.vibrate(1000);
    return navigator.notification.alert("Wake up, Sheeple", toggleAlarm(), "Lucid", "Dismiss");
  };

  /*
  Audio player
  */


  injectThoughts = function() {
    var audioClip, cycleDuration;
    cycleDuration = 10000;
    audioClip = new Media("../www/audio/inception.wav");
    return window.audioPlayer = setInterval(function() {
      console.log("Injecting thoughts...");
      return audioClip.play();
    }, cycleDuration);
  };

  /*
  REM Sleep detection
  */


  countdownToDeepSleep = function() {
    return window.countdown = setInterval(function() {
      duration = duration - 1000;
      console.log(duration);
      if (duration === 0) {
        cancelDeepSleepCountdown();
        console.log("We're ready to send audio");
        return injectThoughts();
      }
    }, 1000);
  };

  cancelDeepSleepCountdown = function() {
    clearInterval(window.countdown);
    return duration = 10000;
  };

  interruptDeepSleepCountdown = function() {
    return duration = 10000;
  };

  /*
  Watch for movement
  */


  startMonitoringMovement = function() {
    var accelerometerError, accelerometerOptions, accelerometerSuccess;
    accelerometerSuccess = function(acceleration) {
      if (acceleration.x > 1 || acceleration.x < -1 || acceleration.y > 1 || acceleration.y < -1) {
        console.log("movement!");
        return interruptDeepSleepCountdown();
      }
    };
    accelerometerError = function() {
      return alert("Error watching accelerometer");
    };
    accelerometerOptions = {
      frequency: 100
    };
    return window.accelerometerMonitor = navigator.accelerometer.watchAcceleration(accelerometerSuccess, accelerometerError, accelerometerOptions);
  };

  stopMonitoringMovement = function(monitorID) {
    return navigator.accelerometer.clearWatch(monitorID);
  };

}).call(this);
